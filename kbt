#!/bin/bash

set -e  # Exit if e

# Path to programs
COMPILER="./Bin/lang"
ASSEMBLER="./Bin/assembler"
PROCESSOR="./Bin/processor"

# Colors
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
NC='\033[0m'

print_error() { echo -e "${RED}Ошибка:${NC} $1" >&2; }
print_success() { echo -e "${GREEN}Успешно:${NC} $1"; }
print_info() { echo -e "${YELLOW}Инфо:${NC} $1"; }

# Functions print with color
print_step() { echo -e "${NC}→ $1"; }
print_output() { echo -e "${NC}   $1"; }

# Check and build all tools
check_tool() {
    local tool="$1"
    local path="$2"
    local make_target="$3"

    if [ ! -f "$path" ]; then
        print_step "Сборка $tool..."
        if make "$make_target" 2>/dev/null; then
            print_success "$tool собран"
        else
            print_error "Не удалось собрать $tool"
            exit 1
        fi
    fi
}

show_help() {
    cat << EOF
kbt - Компилятор KBT языка
Использование: kbt <входной_файл> [опция]

Опции:
  -ct      Код → AST дерево (сохраняет .ast файл)
  -ca      Код → Ассемблер (сохраняет .asm файл)
  -ta      AST → Ассемблер (сохраняет .asm файл)
  -ab      Ассемблер → Бинарник
  -bs      Бинарник → Запуск
  -all     Полный цикл: Код → Бинарник → Запуск
  -h       Показать справку

Примеры:
  kbt program.kbt -ct    # Сохранить AST дерево
  kbt program.kbt -ca    # Создать ассемблерный код
  kbt program.kbt -all   # Скомпилировать и запустить
EOF
}

main() {
    if [ $# -lt 2 ] || [ "$1" = "-h" ]; then
        show_help
        exit 0
    fi

    INPUT_FILE="$1"
    MODE="$2"

    if [ ! -f "$INPUT_FILE" ]; then
        print_error "Файл не найден: $INPUT_FILE"
        exit 1
    fi

    BASENAME="${INPUT_FILE%.*}"
    check_tools

    case "$MODE" in
        -ct)
            print_step "Компиляция в AST дерево..."
            "$COMPILER" "$INPUT_FILE" -ct "${BASENAME}.ast" 2>/dev/null
            print_success "AST дерево сохранено в ${BASENAME}.ast"
            ;;

        -ca)
            print_step "Компиляция в ассемблер..."
            "$COMPILER" "$INPUT_FILE" -ca "${BASENAME}.asm" 2>/dev/null
            print_success "Ассемблерный код сохранен в ${BASENAME}.asm"
            ;;

        -ta)
            print_step "Компиляция AST дерева в ассемблер..."
            "$COMPILER" "$INPUT_FILE" -ta "${BASENAME}.asm" 2>/dev/null
            print_success "Ассемблерный код сохранен в ${BASENAME}.asm"
            ;;

        -tc)
            print_step "Перевод AST дерева в код..."
            "$COMPILER" "$INPUT_FILE" -tc "${BASENAME}.cod" 2>/dev/null
            print_success "Код сохранен в ${BASENAME}.asm"
            ;;

        -f)
            print_step "Форматирование кода..."
            "$COMPILER" "$INPUT_FILE" -cc "${BASENAME}.cod" 2>/dev/null
            print_success "Код сохранен в ${BASENAME}.asm"
            ;;

        -bs)
            print_step "Запуск программы..."
            echo "====================== ВЫВОД ПРОГРАММЫ ======================"
            "$PROCESSOR" -InpFile="$INPUT_FILE"
            echo "============================================================"
            ;;

        -ab)
            print_step "Ассемблирование в бинарник..."
            "$ASSEMBLER" -InpFile="$INPUT_FILE" -OutFile="${BASENAME}.bin" 2>/dev/null
            print_success "Код сохранен в ${BASENAME}.bin"
            ;;

        -as)
            print_step "1. Ассемблирование в бинарник..."
            "$ASSEMBLER" -InpFile="$INPUT_FILE" -OutFile="${BASENAME}.bin" 2>/dev/null

            print_step "2. Запуск программы..."
            echo "====================== ВЫВОД ПРОГРАММЫ ======================"
            "$PROCESSOR" -InpFile="${BASENAME}.bin"
            echo "============================================================"

            rm -f "${BASENAME}.bin"
            print_success "Программа выполнена успешно"
            ;;


        -all)
            TEMP_ASM="${BASENAME}_temp.asm"
            TEMP_BIN="${BASENAME}_temp.bin"

            print_step "1. Компиляция в ассемблер..."
            "$COMPILER" "$INPUT_FILE" -ca "$TEMP_ASM" # 2>/dev/null

            print_step "2. Ассемблирование в бинарник..."
            "$ASSEMBLER" -InpFile="$TEMP_ASM" -OutFile="$TEMP_BIN" 2>/dev/null

            print_step "3. Запуск программы..."
            echo "====================== ВЫВОД ПРОГРАММЫ ======================"
            "$PROCESSOR" -InpFile="$TEMP_BIN"
            echo "============================================================"

            rm -f "$TEMP_ASM" "$TEMP_BIN"
            print_success "Программа выполнена успешно"
            ;;

        *)
            print_error "Неизвестная опция: $MODE"
            echo "Используйте kbt -h для справки"
            exit 1
            ;;
    esac
}

check_tools() {
    check_tool "компилятор" "$COMPILER" "lang"
    check_tool "ассемблер" "$ASSEMBLER" "assembler"
    check_tool "процессор" "$PROCESSOR" "processor"
}

main "$@"
