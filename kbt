#!/bin/bash

set -e  # Выход при ошибке

# Пути к инструментам
COMPILER="./Bin/lang"
ASSEMBLER="./Bin/assembler"
PROCESSOR="./Bin/processor"

# Цвета для вывода
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
NC='\033[0m' # No Color

print_error() { echo -e "${RED}Ошибка:${NC} $1"; }
print_success() { echo -e "${GREEN}Успешно:${NC} $1"; }
print_info() { echo -e "${YELLOW}Инфо:${NC} $1"; }

# Проверка и сборка инструментов
check_tool() {
    local tool="$1"
    local path="$2"
    local make_target="$3"

    if [ ! -f "$path" ]; then
        print_info "Сборка $tool..."
        if make "$make_target"; then
            print_success "$tool собран"
        else
            print_error "Не удалось собрать $tool"
            exit 1
        fi
    fi
}

# Проверка всех инструментов
check_tools() {
    check_tool "компилятор" "$COMPILER" "lang"
    check_tool "ассемблер" "$ASSEMBLER" "assembler"
    check_tool "процессор" "$PROCESSOR" "processor"
}

# Показать справку
show_help() {
    echo "kbt"
    echo "Использование: kbt <входной_файл> [опция]"
    echo ""
    echo "Опции:"
    echo "  -ct      Код → AST дерево (сохраняет .ast файл)"
    echo "  -ca      Код → Ассемблер (сохраняет .asm файл)"
    echo "  -all     Код → Бинарник → Запуск"
    echo "  -h       Показать эту справку"
    echo ""
    echo "Примеры:"
    echo "  kbt program.kbt -ct    # Сохранить AST дерево"
    echo "  kbt program.kbt -ca    # Создать ассемблерный код"
    echo "  kbt program.kbt -all   # Скомпилировать и запустить"
}

# Основная функция
main() {
    # Проверяем аргументы
    if [ $# -lt 2 ]; then
        if [ "$1" = "-h" ]; then
            show_help
            exit 0
        fi
        print_error "Использование: kbt <файл> [-ct | -ca | -ta | -all]"
        echo "Используйте kbt -h для справки"
        exit 1
    fi

    INPUT_FILE="$1"
    MODE="$2"

    # Проверяем входной файл
    if [ ! -f "$INPUT_FILE" ]; then
        print_error "Файл не найден: $INPUT_FILE"
        exit 1
    fi

    BASENAME="${INPUT_FILE%.*}"
    check_tools

    # Обрабатываем режимы
    case "$MODE" in
        -ct)
            # Код → AST дерево
            print_info "Компиляция в AST дерево..."
            "$COMPILER" "$INPUT_FILE" -ct "${BASENAME}.ast"
            print_success "AST дерево сохранено в ${BASENAME}.ast"
            ;;

        -ca)
            # Код → Ассемблер
            print_info "Компиляция в ассемблер..."
            "$COMPILER" "$INPUT_FILE" -ca "${BASENAME}.asm"
            print_success "Ассемблерный код сохранен в ${BASENAME}.asm"
            ;;

        -ta)
            # Дерево → Ассемблер
            print_info "Компиляция в ассемблер..."
            "$COMPILER" "$INPUT_FILE" -ta "${BASENAME}.asm"
            print_success "Ассемблерный код сохранен в ${BASENAME}.asm"
            ;;

        -ab)
            # Ассемблер → Бинарник
            print_info "Компиляция в ассемблер..."
            "$ASSEMBLER" -InpFile="$INPUT_FILE" -OutFile="${BASENAME}.bin"
            print_success "Бинарный код сохранен в ${BASENAME}.bin"
            ;;

        -bs)
            # Бинарник → Запуск
            print_info "Запуск программы..."
            echo "====================== ВЫВОД ПРОГРАММЫ ======================"
            "$PROCESSOR" -InpFile="$INPUT_FILE"
            echo "============================================================"
            print_info "Компиляция в ассемблер..."
            ;;

        -all)
            # Полный цикл: Код → Бинарник → Запуск
            TEMP_ASM="${BASENAME}_temp.asm"
            TEMP_BIN="${BASENAME}_temp.bin"

            print_info "1. Компиляция в ассемблер..."
            "$COMPILER" "$INPUT_FILE" -ca "$TEMP_ASM"

            print_info "2. Ассемблирование в бинарник..."
            "$ASSEMBLER" -InpFile="$TEMP_ASM" -OutFile="$TEMP_BIN"

            print_info "3. Запуск программы..."
            echo "====================== ВЫВОД ПРОГРАММЫ ======================"
            "$PROCESSOR" -InpFile="$TEMP_BIN"
            echo "============================================================"

            # Очистка временных файлов
            rm -f "$TEMP_ASM" "$TEMP_BIN"
            print_success "Программа выполнена успешно"
            ;;

        *)
            print_error "Неизвестная опция: $MODE"
            echo "Доступные опции: -ct, -ca, -all"
            exit 1
            ;;
    esac
}

# Запуск основной функции
main "$@"
